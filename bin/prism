#!/bin/bash
# PRISM Framework CLI - Main command-line interface

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# PRISM is installed in ~/.prism
PRISM_ROOT="$HOME/.prism"

# Source libraries
source "${PRISM_ROOT}/lib/prism-core.sh"
source "${PRISM_ROOT}/lib/prism-log.sh"
source "${PRISM_ROOT}/lib/prism-security.sh"
source "${PRISM_ROOT}/lib/prism-skills.sh"

# Version is now inherited from prism-core.sh which reads from VERSION file
readonly PRISM_CLI_VERSION="${PRISM_VERSION}"

# Show help message
show_help() {
    cat << EOF
PRISM Framework v${PRISM_CLI_VERSION}
Persistent Real-time Intelligent System Management

Usage: prism <command> [options]

Commands:
  init [options]       Initialize PRISM in current directory
  context <action>     Manage project context
  session <action>     Manage development sessions
  prd <action>         Manage Product Requirement Documents
  tasks <action>       Manage feature task lists
  skill <action>       Manage Claude Code skills
  toon <action>        TOON format conversion and optimization
  config <action>      Configure PRISM settings
  update [options]     Update PRISM framework
  agent <action>       Multi-agent orchestration and coordination
  doctor              Diagnose and fix issues
  version             Show version information
  help                Show this help message

Init Options:
  --template <name>    Use specific template (default, nodejs, python)
  --force             Overwrite existing configuration
  --minimal           Create minimal setup

Context Actions:
  add [priority] [tags] [name]  Add new context entry
  query <search-term>            Search context files
  export [format] [output]       Export context (markdown/json/yaml)
  update-templates               Update context templates
  load-critical                  Load critical context items

Session Actions:
  start [description]            Start new development session
  status                         Show current session status
  archive                        Archive current session
  restore <session-id>           Restore previous session
  export [format] [session-id]   Export session report
  refresh                        Refresh session context
  clean [days]                   Clean old sessions

PRD Actions:
  create <feature-name>          Create new PRD from template
  amend <feature-name> "change"  Amend existing PRD
  list                           List all PRDs

Task Actions:
  generate <prd-file>            Generate task list from PRD
  status [feature-name]          Show task completion status
  list                           List all task files

Skill Actions:
  create                         Create a new skill interactively
  list [-v]                      List all available skills
  info <name>                    Show skill details
  link-claude                    Link to Claude Code directory
  stats                          Show skills statistics

Config Actions:
  get <key>          Get configuration value
  set <key> <value>  Set configuration value
  list              List all configuration
  reset             Reset to defaults

Agent Orchestration:
  init                     Initialize agent system
  create <type> [name]     Create a specialized agent
  execute <id>             Execute agent task
  list                     List active agents
  swarm create <name>      Create agent swarm
  swarm execute <id>       Execute swarm tasks
  decompose <task>         Decompose complex task

Update Options:
  --check            Check for updates only
  --force            Force update even if current
  --beta             Include beta versions

Global Options:
  -v, --verbose      Enable verbose output
  -q, --quiet        Suppress non-error output
  --no-color        Disable colored output
  --log-level <lvl>  Set log level (TRACE,DEBUG,INFO,WARN,ERROR)

Examples:
  prism init                       Initialize in current directory
  prism init --template nodejs     Initialize with Node.js template
  prism context add HIGH security  Add high-priority security context
  prism context query "auth"       Search for authentication context
  prism session start "new feature" Start session for new feature
  prism session status             Check current session status
  prism update --check             Check for updates
  prism doctor                     Diagnose issues

Documentation:
  https://github.com/afiffattouh/hildens-prism

Report Issues:
  https://github.com/afiffattouh/hildens-prism/issues
EOF
}

# Parse global options
parse_global_options() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -v|--verbose)
                set_log_level "DEBUG"
                shift
                ;;
            -q|--quiet)
                set_log_level "ERROR"
                shift
                ;;
            --no-color)
                export NO_COLOR=1
                shift
                ;;
            --log-level)
                set_log_level "$2"
                shift 2
                ;;
            *)
                break
                ;;
        esac
    done

    # Return remaining arguments
    echo "$@"
}

# Initialize PRISM in current directory
cmd_init() {
    local template="default"
    local force=false
    local minimal=false

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --template)
                template="$2"
                shift 2
                ;;
            --force)
                force=true
                shift
                ;;
            --minimal)
                minimal=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                return 1
                ;;
        esac
    done

    # Check if already initialized
    if [[ -d .prism ]] && [[ "$force" != "true" ]]; then
        log_warn "PRISM is already initialized in this directory"
        log_info "Use --force to reinitialize"
        return 1
    fi

    log_header "Initializing PRISM Framework"

    # Source initialization script
    source "${PRISM_ROOT}/lib/prism-init.sh"

    # Run initialization
    if prism_init "$template" "$minimal"; then
        log_info "‚úÖ PRISM initialized successfully!"
        log_info "Next steps:"
        log_info "  1. Review .prism/context/architecture.md"
        log_info "  2. Update CLAUDE.md with project specifics"
        log_info "  3. Run 'prism doctor' to verify setup"
    else
        log_error "Failed to initialize PRISM"
        return 1
    fi
}

# Manage context files
cmd_context() {
    local action=$1
    shift

    source "${PRISM_ROOT}/lib/prism-context.sh"

    case "$action" in
        add)
            local priority=${1:-MEDIUM}
            local tags=${2:-general}
            local component=${3:-"New Component"}
            prism_context_add "$priority" "$tags" "$component"
            ;;
        query)
            local query=$1
            if [[ -z "$query" ]]; then
                log_error "Please specify a search query"
                return 1
            fi
            prism_context_query "$query"
            ;;
        export)
            local format=${1:-markdown}
            local output=${2:-"prism-context-export"}
            prism_context_export "$format" "$output"
            ;;
        update-templates)
            prism_context_update_templates
            ;;
        load-critical)
            prism_context_load_critical
            ;;
        list-toon|toon)
            local priority_filter=${1:-all}
            prism_context_list_toon "$priority_filter"
            ;;
        *)
            log_error "Unknown context action: $action"
            log_info "Valid actions: add, query, export, update-templates, load-critical, list-toon"
            return 1
            ;;
    esac
}

# Manage sessions
cmd_session() {
    local action=$1
    shift

    source "${PRISM_ROOT}/lib/prism-session.sh"

    case "$action" in
        start)
            local description=${1:-"Development session"}
            prism_session_start "$description"
            ;;
        status)
            # Support --toon flag
            if [[ "${1:-}" == "--toon" ]]; then
                prism_session_status "toon"
            else
                prism_session_status "human"
            fi
            ;;
        list-toon|toon)
            local max_sessions=${1:-10}
            prism_session_list_toon "$max_sessions"
            ;;
        archive)
            prism_session_archive
            ;;
        restore)
            local session_id=$1
            if [[ -z "$session_id" ]]; then
                log_error "Please specify a session ID"
                log_info "Available sessions:"
                ls -1 .prism/sessions/archive/*.md 2>/dev/null | xargs -n1 basename | sed 's/.md$//' || echo "  (no archived sessions)"
                return 1
            fi
            prism_session_restore "$session_id"
            ;;
        export)
            local format=${1:-markdown}
            local session_id=${2:-current}
            prism_session_export "$format" "$session_id"
            ;;
        refresh)
            prism_session_refresh
            ;;
        clean)
            local days=${1:-30}
            prism_session_clean "$days"
            ;;
        *)
            log_error "Unknown session action: $action"
            log_info "Valid actions: start, status, status --toon, list-toon, archive, restore, export, refresh, clean"
            return 1
            ;;
    esac
}

# Manage PRDs (Product Requirement Documents)
cmd_prd() {
    local action=$1
    shift

    source "${PRISM_ROOT}/lib/prism-prd.sh"

    case "$action" in
        create)
            local feature_name=$1
            if [[ -z "$feature_name" ]]; then
                log_error "Please specify a feature name"
                log_info "Usage: prism prd create <feature-name>"
                return 1
            fi
            prism_prd_create "$feature_name"
            ;;
        amend)
            local feature_name=$1
            local amendment=$2
            if [[ -z "$feature_name" ]]; then
                log_error "Please specify a feature name"
                log_info "Usage: prism prd amend <feature-name> \"amendment description\""
                return 1
            fi
            if [[ -z "$amendment" ]]; then
                log_error "Please specify amendment description"
                log_info "Usage: prism prd amend <feature-name> \"amendment description\""
                return 1
            fi
            prism_prd_amend "$feature_name" "$amendment"
            ;;
        list)
            prism_prd_list
            ;;
        help|--help)
            prism_prd_help
            ;;
        *)
            log_error "Unknown PRD action: $action"
            log_info "Valid actions: create, amend, list"
            log_info "Run 'prism prd help' for more information"
            return 1
            ;;
    esac
}

# Manage tasks
cmd_tasks() {
    local action=$1
    shift

    source "${PRISM_ROOT}/lib/prism-prd.sh"

    case "$action" in
        generate)
            local prd_file=$1
            if [[ -z "$prd_file" ]]; then
                log_error "Please specify a PRD file"
                log_info "Usage: prism tasks generate <prd-file>"
                return 1
            fi
            prism_tasks_generate "$prd_file"
            ;;
        status)
            local feature_name=${1:-}
            prism_tasks_status "$feature_name"
            ;;
        list)
            prism_tasks_list
            ;;
        help|--help)
            prism_prd_help
            ;;
        *)
            log_error "Unknown tasks action: $action"
            log_info "Valid actions: generate, status, list"
            log_info "Run 'prism tasks help' for more information"
            return 1
            ;;
    esac
}

# Manage configuration
cmd_config() {
    local action=$1
    shift

    source "${PRISM_ROOT}/lib/prism-config.sh"

    case "$action" in
        get)
            local key=$1
            if [[ -z "$key" ]]; then
                log_error "Please specify a configuration key"
                return 1
            fi
            prism_config_get "$key"
            ;;
        set)
            local key=$1
            local value=$2
            if [[ -z "$key" ]] || [[ -z "$value" ]]; then
                log_error "Usage: prism config set <key> <value>"
                return 1
            fi
            prism_config_set "$key" "$value"
            ;;
        list)
            prism_config_list
            ;;
        reset)
            prism_config_reset
            ;;
        *)
            log_error "Unknown config action: $action"
            log_info "Valid actions: get, set, list, reset"
            return 1
            ;;
    esac
}

# Update PRISM
cmd_update() {
    local check_only=false
    local force=false
    local beta=false

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --check)
                check_only=true
                shift
                ;;
            --force)
                force=true
                shift
                ;;
            --beta)
                beta=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                return 1
                ;;
        esac
    done

    source "${PRISM_ROOT}/lib/prism-update.sh"
    prism_update "$check_only" "$force" "$beta"
}

# Skills management command
cmd_skill() {
    # Create a temporary script to run skill commands without strict mode conflicts
    local temp_script=$(mktemp)
    cat > "$temp_script" << 'EOF'
#!/bin/bash
export PRISM_NO_STRICT=1
source "$PRISM_ROOT/lib/prism-core.sh"
source "$PRISM_ROOT/lib/prism-log.sh"
source "$PRISM_ROOT/lib/prism-skills.sh"

# Call the skills command handler
prism_skills "$@"
EOF

    # Execute the script and clean up
    PRISM_ROOT="$PRISM_ROOT" bash "$temp_script" "$@"
    local result=$?
    rm -f "$temp_script"
    return $result
}

# TOON (Tree Object Notation) command
cmd_toon() {
    source "${PRISM_ROOT}/lib/prism-toon.sh"

    local subcmd="${1:-help}"
    shift || true

    case "$subcmd" in
        convert)
            local input_file="${1:--}"
            local output_file="${2:-}"

            if [[ "$input_file" == "-" ]]; then
                # Read from stdin
                local data=$(cat)
            else
                if [[ ! -f "$input_file" ]]; then
                    log_error "File not found: $input_file"
                    return 1
                fi
                local data=$(cat "$input_file")
            fi

            local toon_output=$(toon_optimize "$data")

            if [[ -n "$output_file" ]]; then
                echo "$toon_output" > "$output_file"
                log_info "TOON output written to: $output_file"
            else
                echo "$toon_output"
            fi
            ;;

        benchmark)
            local input_file="$1"
            if [[ -z "$input_file" ]]; then
                log_error "Usage: prism toon benchmark <input-file>"
                return 1
            fi
            toon_benchmark "$input_file"
            ;;

        validate)
            local toon_file="$1"
            if [[ -z "$toon_file" ]]; then
                log_error "Usage: prism toon validate <toon-file>"
                return 1
            fi

            if [[ ! -f "$toon_file" ]]; then
                log_error "File not found: $toon_file"
                return 1
            fi

            local toon_data=$(cat "$toon_file")
            if toon_validate "$toon_data"; then
                log_info "‚úÖ TOON validation passed"
                return 0
            else
                log_error "‚ùå TOON validation failed"
                return 1
            fi
            ;;

        clear-cache)
            toon_clear_cache
            ;;

        stats)
            # Show TOON usage statistics
            cat << 'STATS'
üìä TOON Usage Statistics (PRISM v2.3.x)

Performance Benchmarks:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Component         Token Savings    Status
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Agents            40-53%           ‚úÖ Phase 2 Complete
Context           49%              ‚úÖ Phase 3 Complete
Sessions          35-45%           ‚è≥ Phase 5 Planned
Average           41-49%           ‚úÖ Operational

Feature Flags:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
PRISM_TOON_ENABLED    = ${PRISM_TOON_ENABLED:-true}
PRISM_TOON_AGENTS     = ${PRISM_TOON_AGENTS:-true}
PRISM_TOON_CONTEXT    = ${PRISM_TOON_CONTEXT:-true}
PRISM_TOON_SESSION    = ${PRISM_TOON_SESSION:-true}

Cache Directory:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Location: ${TOON_CACHE_DIR:-/tmp/prism-toon-cache}
STATS

            # Show cache stats if directory exists
            if [[ -d "${TOON_CACHE_DIR:-/tmp/prism-toon-cache}" ]]; then
                local cache_count=$(find "${TOON_CACHE_DIR:-/tmp/prism-toon-cache}" -name "*.toon" 2>/dev/null | wc -l | tr -d ' ')
                local cache_size=$(du -sh "${TOON_CACHE_DIR:-/tmp/prism-toon-cache}" 2>/dev/null | cut -f1)
                echo "Cached files: $cache_count"
                echo "Cache size:   $cache_size"
            else
                echo "Cached files: 0 (cache empty)"
            fi

            echo ""
            echo "Run 'prism toon demo' to see TOON conversion examples"
            ;;

        demo)
            # Interactive demo of TOON conversions
            cat << 'DEMO'
üéØ TOON Conversion Demo

Example 1: Simple Array
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Original JSON (89 tokens):
{
  "users": [
    {"id": 1, "name": "Alice", "role": "admin"},
    {"id": 2, "name": "Bob", "role": "user"},
    {"id": 3, "name": "Charlie", "role": "user"}
  ]
}

TOON Format (35 tokens - 61% savings):
users[3]{id,name,role}:
 1,Alice,admin
 2,Bob,user
 3,Charlie,user

Example 2: Context Metadata
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Original JSON (191 tokens):
[
  {"file":"architecture.md","priority":"critical","size":851,"lines":43},
  {"file":"security.md","priority":"critical","size":1213,"lines":43},
  {"file":"patterns.md","priority":"high","size":1603,"lines":65},
  ...7 files total
]

TOON Format (97 tokens - 49% savings):
items[7]{file,priority,size,lines}:
 architecture.md,critical,851,43
 security.md,critical,1213,43
 patterns.md,high,1603,65
 ...

Example 3: Agent Configuration
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Original JSON (54 tokens):
{"id":"agent_001","type":"architect","state":"active","task":"Design API"}

TOON Format (25 tokens - 54% savings):
items[1]{id,type,state,task}:
 agent_001,architect,active,"Design API"

Try it yourself:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  echo '[{"id":1,"name":"test"}]' | prism toon convert -
  prism toon benchmark <your-file.json>
  prism context list-toon all
DEMO
            ;;

        help|--help|-h)
            cat << 'HELP'
PRISM TOON Commands - Token-Optimized Object Notation

Usage:
  prism toon <command> [options]

Commands:
  convert <input> [output]    Convert JSON/YAML to TOON format
                              Use '-' for stdin input
  benchmark <input>           Show token savings comparison
  validate <toon-file>        Validate TOON syntax
  stats                       Show TOON usage statistics and performance
  demo                        Interactive demo with examples
  clear-cache                 Clear TOON conversion cache
  help                        Show this help message

Examples:
  prism toon convert data.json            # Convert and print to stdout
  prism toon convert data.json output.toon # Convert and save
  prism toon benchmark data.json          # Show optimization stats
  prism toon validate output.toon         # Validate TOON file
  cat data.json | prism toon convert -    # Convert from stdin

TOON Format:
  Tree Object Notation (TOON) is a token-optimized format designed for
  LLM interactions. It achieves 30-60% token reduction by using tabular
  arrays with minimal punctuation.

  Example:
    JSON (45 tokens):              TOON (20 tokens):
    {"items": [                    items[2]{id,name}:
      {"id": 1, "name": "test"},    1,test
      {"id": 2, "name": "demo"}     2,demo
    ]}

Feature Flags:
  PRISM_TOON_ENABLED=false      Disable TOON globally
  PRISM_TOON_AGENTS=false       Disable TOON for agents
  PRISM_TOON_CONTEXT=false      Disable TOON for context
  PRISM_TOON_SESSION=false      Disable TOON for sessions
HELP
            ;;

        *)
            log_error "Unknown TOON command: $subcmd"
            log_info "Run 'prism toon help' for usage information"
            return 1
            ;;
    esac
}

# Agent orchestration command
cmd_agent() {
    # Create a temporary script to run agent commands without strict mode conflicts
    local temp_script=$(mktemp)
    cat > "$temp_script" << 'EOF'
#!/bin/bash
export PRISM_NO_STRICT=1
source "$PRISM_ROOT/lib/prism-core.sh"
source "$PRISM_ROOT/lib/prism-log.sh"
source "$PRISM_ROOT/lib/prism-agents.sh"
source "$PRISM_ROOT/lib/prism-claude-agents.sh" 2>/dev/null || true

# Call the agent command handler
action="$1"
shift

case "$action" in
    init)
        init_agent_system "$@"
        ;;
    create)
        create_agent "$@"
        ;;
    execute)
        execute_agent_task "$@"
        ;;
    list)
        # Support optional --toon flag for TOON format
        if [[ "${2:-}" == "--toon" ]]; then
            list_active_agents "toon"
        else
            list_active_agents "human"
        fi
        ;;
    result)
        get_agent_result "$@"
        ;;
    cleanup)
        cleanup_agents
        ;;
    swarm)
        cmd_swarm "$@"
        ;;
    decompose)
        decompose_task "$@"
        ;;
    *)
        log_error "Unknown agent command: $action"
        echo "Usage: prism agent {init|create|execute|list|result|cleanup|swarm|decompose}"
        exit 1
        ;;
esac
EOF

    # Execute the script and clean up
    PRISM_ROOT="$PRISM_ROOT" bash "$temp_script" "$@"
    local result=$?
    rm -f "$temp_script"
    return $result
}

# Run diagnostics
cmd_doctor() {
    log_header "PRISM Doctor - System Diagnostics"

    source "${PRISM_ROOT}/lib/prism-doctor.sh"
    prism_doctor
}

# Show version
cmd_version() {
    echo "PRISM Framework v${PRISM_CLI_VERSION}"
    echo "Copyright (c) 2024 PRISM Contributors"
    echo "License: MIT"
    echo ""
    echo "Components:"
    echo "  Core Library: v${PRISM_VERSION}"
    echo "  Security Library: v${PRISM_VERSION}"
    echo "  Log Library: v${PRISM_VERSION}"
}

# Main command dispatcher
main() {
    # Parse global options - modifies $@ directly
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -v|--verbose)
                set_log_level "DEBUG"
                shift
                ;;
            -q|--quiet)
                set_log_level "ERROR"
                shift
                ;;
            --no-color)
                export NO_COLOR=1
                shift
                ;;
            --log-level)
                set_log_level "$2"
                shift 2
                ;;
            *)
                break
                ;;
        esac
    done

    # Get command
    local command=${1:-help}
    shift

    # Dispatch command
    case "$command" in
        init)
            cmd_init "$@"
            ;;
        context)
            cmd_context "$@"
            ;;
        session)
            cmd_session "$@"
            ;;
        prd)
            cmd_prd "$@"
            ;;
        tasks)
            cmd_tasks "$@"
            ;;
        skill)
            cmd_skill "$@"
            ;;
        toon)
            cmd_toon "$@"
            ;;
        config)
            cmd_config "$@"
            ;;
        update)
            cmd_update "$@"
            ;;
        agent)
            cmd_agent "$@"
            ;;
        doctor)
            cmd_doctor "$@"
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"